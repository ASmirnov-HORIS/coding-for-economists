---
jupytext:
  cell_metadata_filter: -all
  formats: md:myst
  text_representation:
    extension: .md
    format_name: myst
    format_version: '0.8'
    jupytext_version: 1.5.0
kernelspec:
  display_name: 'Python 3.8.12 64-bit (''codeforecon'': conda)'
  language: python
  name: python3
---

(auto-reports)=
# Automating Reports

In this chapter, you'll learn how to set up *automated reporting* with code, by which we mean creating outputs such as PDF files, Microsoft Word (or open office) text documents, and even slides where the content is partly text and partly generated by code. For example, a technical report exploring recent trade statistics in which the code part pulls down the latest data and plots it.

There are many solid use cases for automated reports, including:

- reports that use data and/or charts and that are similar each time they are run (eg only the data are updated)
- technical reports that show or use the functionality of an existing code base
- slide decks that summarise the most recent data and that are produced at a regular frequency
- amazingly, it can also be used to create automatically updated websites relatively easily——but we won't cover that in this chapter

For this chapter, you will need an installation of **Jupyter Lab** (which can be installed via `pip install jupyterlab`), an installation of a programme called [**Quarto**](https://quarto.org/), and the other Python packages as used below. For some types of output, you'll also need to have an installation of the typesetting language **LaTeX**, for which this book recommends the [MikTeX](https://miktex.org/download) distribution.

This chapter has benefitted from work on automated reporting templates by the ever-talented [Grant McDermott](https://grantmcdermott.com/).

## Automated Reports with **Quarto**

The tool that we'll be using to do this is [**Quarto**](https://quarto.org/). You can check you've installed it properly using `quarto check install` on the command line. **Quarto** is a really convenient wrapper for a bunch of other tools that makes it convenient to produce automated reports. You should check the latest [documentation](https://quarto.org/docs/getting-started/quarto-basics.html) for an up to date guide on use——here, we're going to see the basics and introduce a couple of templates that will serve you well.

Quarto can be used to create *output* documents and slides in a wide variety of formats including HTML, PDF, Microsoft Office (docx and pptx), OpenOffice, and many more.

You can write the *input* documents (and code) for these in two possible ways:

1. A special kind of markdown file, with extension `.qmd`
2. Jupyter Notebooks, with extension `.ipynb` (which most of this book is written in)

You optionally add code (e.g. Python, R, JavaScript, etc.) to the documents to dynamically create figures, tables, etc. and then render the documents to their final format using Quarto.

If you only want to work one way, this book recommends the latter, using Jupyter Notebooks. But some of the key principles for both will be covered in the next sub-section.

### A minimal example of a report written with markdown

We're now going to try the most minimal example of the first approach, a `.qmd` file, that also includes code and outputs.

There are advantages and disadvantages to writing your report in the `.qmd` format. The advantage is that it's just a plain text file and therefore anyone can open it, look at it, and change it with a text editor (and it's more convenient for version control in this way too). The big, big disadvantage is that you cannot see how the code is coming on as you write it (you have to render it to see the code outputs, as we'll see in a moment). In the next sub-section, we'll see a way of achieving a better workflow.

Let's get our minimal example setup. The below code and markdown form the content of a file called `report.qmd`:

````markdown
---
title: "Example Report"
author: "Joan Robinson"
format: pdf
toc: true
number-sections: true
jupyter: python3
---

## Polar Axis

For a demonstration of a line plot on a polar axis, see @fig-polar.

```{python}
#| label: fig-polar
#| fig-cap: "A line plot on a polar axis"

import numpy as np
import matplotlib.pyplot as plt

r = np.arange(0, 2, 0.01)
theta = 2 * np.pi * r
fig, ax = plt.subplots(subplot_kw={'projection': 'polar'})
ax.plot(theta, r)
ax.set_rticks([0.5, 1, 1.5, 2])
ax.grid(True)
plt.show()
```

For an example of a code output where the input is not shown, the code below will *only* show the output table by using the `echo: false` option.

```{python}
#| echo: false
import pandas as pd
import seaborn as sns

df = sns.load_dataset("penguins")
pd.crosstab(df["species"], [df["island"], df["sex"]], margins=True)
```

````

To turn this report into a PDF, save it as `report.qmd` and then, on the command line and in the same directory as the file, run

```bash
quarto render report.qmd
```

```{admonition} Exercise

Successfuly create a PDF by saving the markdown above into a file called `report.qmd` and then running the quarto render command.

If you get an error about not being able to find the Jupyter kernel, first check you have Jupyter Lab installed and then check what your Jupyter kernel is called using `jupyter kernelspec list` on the command line. You need to specify the name of your Jupyter kernel correct in the header document (in the example above, it's called 'python3', which is the default).

```

Now, because we specified `pdf` in the 'header' of our file we automatically got a pdf. But a wide range of output formats are available. For example, HTML

```bash
quarto render report.qmd --to html
```

and Microsoft Word

```bash
quarto render report.qmd --to docx
```

One slight frustration with the conversion to Word Documents is that tables from code (dataframes) are not rendered as tables in the Word doc.

The basic syntax is to write `--to outputformat` at the end of the render command.

```{admonition} Exercise

Successfuly create a HTML report by saving the markdown above into a file called `report.qmd` and then running the quarto render command with the to html option.

What happens to the menu on the right-hand side as you add extra headings using the `##` markdown syntax?

```

Although it's a bit clunky, it's also possible to insert code results in-line with text. Here's a minimal example of that.

````markdown
---
title: "Example Report with Inline Numbers from Code"
author: "Joan Robinson"
format: pdf
toc: true
number-sections: true
jupyter: python3
---

## Report

For a demonstration of a line plot on a polar axis, see @fig-polar.

For an example of a code output where the input is not shown, the code below will *only* show the output table by using the `echo: false` option.

```{python}
#| echo: false
from IPython.display import display, Markdown
import pandas as pd
import seaborn as sns

df = sns.load_dataset("penguins")
big_pen = df["body_mass_g"].max()
number = len(df)
display(
    Markdown(
    """
### The Heaviest Penguin

We find that the heaviest penguin, out of a total of {number} penguins, has a mass of {big_pen:.2f} kilograms.
""".format(big_pen = big_pen, number=number)
)
)
```
````

Note that, in this example, the `:2f` part of `{big_pen:.2f}` is an instruction to report the given number to 2 decimal places.

```{admonition} Exercise

Create a HTML report with an in-line number using the above example but change the formatting of the heaviest penguin to not show any decimal places.

```

There are, of course, loads of extra features that go beyond this example.

### A minimal example of a report written with Jupyter Notebooks

You can also write your reports with Jupyter Notebooks. As a reminder, these have cells that can either text (in the form of markdown) or code (and they support a lot of languages), and have the file format .`.ipynb`. This book recommends working with them in Visual Studio Code. Google Colab notebooks are a type of Jupyter notebook (and can be downloaded as `.ipynb` files).

Writing your automated reports in Jupyter Notebooks has one major advantage over using `.qmd` markdown files: you can run the code as you go, so you know what you're getting and it's easier to weed out bugs. This book recommends this approach to writing automated reports.

So what is the difference from what we've seen above? Very little, actually. Your content will still start with exactly the same header but this time it's going to be in a *markdown cell* at the top of your notebook. To be explicit, the first cell in your notebook will have:

```markdown
---
title: "Example Report"
author: "Joan Robinson"
format: pdf
toc: true
number-sections: true
jupyter: python3
---
```

Subsequent cells will be code or markdown depending on whether you need rich outputs (figures and tables) or text. So, instead of a code chunk that begins with ```` ```{python} ```` like in the `.qmd` approach, you will just create a new code cell.

Remember that putting `format: pdf` into this header will mean that render automatically produces a pdf. You can change it to `format: html` to default to a html file instead——and both options can be over-written by passing `--to format`.

As before, you can create text that is dynamically updated with code outputs too; just choose a code cell rather than a markdown cell.

The main difference when it comes to Jupyter Notebooks is that you must decide whether you want to *execute* the notebook before you render it with **Quarto**. Executing a notebook just means, do you want to run the code first. The command to run a notebook and render it is:

```bash
quarto render jupyter-report.ipynb --execute
```

```{admonition} Exercise

Create a new Jupyter Notebook called `jupyter-report.ipynb` with the header above. Re-use the blocks of code and text from the `qmd` example in the previous section. Render it with the command above.

```

To change the output type, add another instruction to the command using `--to`:

```bash
quarto render jupyter-report.ipynb --execute --to html
```

There's one more big tip on the optimal workflow for making automated reports. Often you are interested in seeing how the final report will look as you change the code in *real time*. This is possible with Jupyter Notebooks and **Quarto**. Run the following in the terminal

```bash
quarto preview jupyter-report.ipynb
```

A browser window will open with a live preview of your pdf (if you set pdf as the default output option in the header). To create a live preview of a HTML document, it's

```bash
quarto preview jupyter-report.ipynb --to html
```

### Customised Automated Reports with **Quarto**

The minimal examples we saw above may not cover everything you want to do.

## Automated Slides with **Quarto**

### A Minimal Example of Automated Slides

### Customised Automated Slides

## Review

From this chapter, you should remember to

- ✅ know what a code style is;
- ✅ not repeat yourself;
- ✅ be consistent with your naming convention;
- ✅ write modular, well-documented code;
- ✅ use interoperable file formats;
- ✅ use relative file paths; and
- ✅ stay zen!
